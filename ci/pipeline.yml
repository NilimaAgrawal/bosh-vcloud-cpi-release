---
groups:
  - name: bosh-vcloud-cpi-release
    jobs:
      - build-candidate
      - deploy-ubuntu-manual
      - bats-ubuntu-manual
      - deploy-centos-manual
      - bats-centos-manual
      - lifecycle

jobs:
  - name: build-candidate
    serial: true
    plan:
      - aggregate:
          - {trigger: true,  get: bosh-cpi-release}
          - {trigger: false, get: version-semver, params: {bump: patch}}

      - put: version-semver
        params: {file: version-semver/number}

      - task: build
        file: bosh-cpi-release/ci/tasks/build-candidate.yml

      - put: bosh-cpi-dev-artifacts
        params: {from: build/out/.*\.tgz}

  - name: deploy-ubuntu-manual
    serial_groups: [ubuntu-director-manual]
    plan:
      - aggregate:
        - {trigger: true,  passed: [build-candidate], get: bosh-cpi-dev-artifacts}
        - {trigger: false, passed: [build-candidate], get: version-semver}
        - {trigger: false, passed: [build-candidate], get: bosh-cpi-release}
        - {trigger: false,                            get: bosh-concourse-ci }
        - {trigger: false,                            get: bosh-init}
        - {trigger: false,                            get: bosh-release}
        - {trigger: false,                            get: stemcell, resource: vcloud-ubuntu-stemcell}

      - task: deploy
        file: bosh-cpi-release/ci/tasks/deploy.yml
        config:
          params:
            base_os: ubuntu
            network_type_to_test: manual

      - conditions: [success, failure]
        task: save-deployment
        file: bosh-cpi-release/ci/tasks/save-deployment.yml
        config:
          params:
            base_os: ubuntu
            network_type_to_test: manual

      - put: bosh-concourse-ci
        params:
          repository: save-deployment/deploy/bosh-concourse-ci
          rebase: true

  - name: bats-ubuntu-manual
    serial_groups: [ubuntu-director-manual] # can't run while deploying
    plan:
      - aggregate:
        - {trigger: true,  passed: [deploy-ubuntu-manual], get: bosh-cpi-dev-artifacts}
        - {trigger: false, passed: [deploy-ubuntu-manual], get: bosh-cpi-release}
        - {trigger: false, passed: [deploy-ubuntu-manual], get: stemcell, resource: vcloud-ubuntu-stemcell}
        - {trigger: false, passed: [deploy-ubuntu-manual], get: bosh-concourse-ci}
        - {trigger: false,                                 get: bats}

      - task: test
        file: bosh-cpi-release/ci/tasks/run-bats.yml
        config:
          params:
            base_os:                            ubuntu
            BAT_NETWORKING:                     manual
            BAT_DIRECTOR:                       {{ubuntu_manual_BAT_DIRECTOR}}
            BAT_VCAP_PASSWORD:                  {{BAT_VCAP_PASSWORD}}

  - name: deploy-centos-manual
    serial_groups: [centos-director-manual]
    plan:
      - aggregate:
        - {trigger: true,  passed: [build-candidate], get: bosh-cpi-dev-artifacts}
        - {trigger: false, passed: [build-candidate], get: version-semver}
        - {trigger: false, passed: [build-candidate], get: bosh-cpi-release}
        - {trigger: false,                            get: bosh-concourse-ci }
        - {trigger: false,                            get: bosh-init}
        - {trigger: false,                            get: bosh-release}
        - {trigger: false,                            get: stemcell, resource: vcloud-centos-stemcell}

      - task: deploy
        file: bosh-cpi-release/ci/tasks/deploy.yml
        config:
          params:
            base_os: centos
            network_type_to_test: manual

      - conditions: [success, failure]
        task: save-deployment
        file: bosh-cpi-release/ci/tasks/save-deployment.yml
        config:
          params:
            base_os: centos
            network_type_to_test: manual

      - put: bosh-concourse-ci
        params:
          repository: save-deployment/deploy/bosh-concourse-ci
          rebase: true

  - name: bats-centos-manual
    serial_groups: [centos-director-manual] # can't run while deploying
    plan:
      - aggregate:
        - {trigger: true,  passed: [deploy-centos-manual], get: bosh-cpi-dev-artifacts}
        - {trigger: false, passed: [deploy-centos-manual], get: bosh-cpi-release}
        - {trigger: false, passed: [deploy-centos-manual], get: stemcell, resource: vcloud-centos-stemcell}
        - {trigger: false, passed: [deploy-centos-manual], get: bosh-concourse-ci}
        - {trigger: false,                                 get: bats}

      - task: test
        file: bosh-cpi-release/ci/tasks/run-bats.yml
        config:
          params:
            base_os:                            centos
            BAT_NETWORKING:                     manual
            BAT_DIRECTOR:                       {{centos_manual_BAT_DIRECTOR}}
            BAT_VCAP_PASSWORD:                  {{BAT_VCAP_PASSWORD}}

  - name: lifecycle
    serial: true
    plan:
      - aggregate:
        - {trigger: true,  passed: [build-candidate], get: bosh-cpi-dev-artifacts} # used for job chaining only not for tasks
        - {trigger: false, passed: [build-candidate], get: bosh-cpi-release}
        - {trigger: false,                            get: bosh-cpi-src}
        - {trigger: false,                            get: stemcell, resource: vcloud-ubuntu-stemcell}

      - task: test
        file: bosh-cpi-release/ci/tasks/run-lifecycle.yml
        config:
          params:
            BOSH_VCLOUD_CPI_URL:                   {{BOSH_VCLOUD_CPI_URL}}
            BOSH_VCLOUD_CPI_USER:                  {{BOSH_VCLOUD_CPI_USER}}
            BOSH_VCLOUD_CPI_PASSWORD:              {{BOSH_VCLOUD_CPI_PASSWORD}}
            BOSH_VCLOUD_CPI_NET_ID:                {{BOSH_VCLOUD_CPI_NET_ID}}
            BOSH_VCLOUD_CPI_ORG:                   {{BOSH_VCLOUD_CPI_ORG}}
            BOSH_VCLOUD_CPI_VDC:                   {{BOSH_VCLOUD_CPI_VDC}}
            BOSH_VCLOUD_CPI_VAPP_CATALOG:          {{BOSH_VCLOUD_CPI_VAPP_CATALOG}}
            BOSH_VCLOUD_CPI_MEDIA_CATALOG:         {{BOSH_VCLOUD_CPI_MEDIA_CATALOG}}
            BOSH_VCLOUD_CPI_MEDIA_STORAGE_PROFILE: {{BOSH_VCLOUD_CPI_MEDIA_STORAGE_PROFILE}}
            BOSH_VCLOUD_CPI_VAPP_STORAGE_PROFILE:  {{BOSH_VCLOUD_CPI_VAPP_STORAGE_PROFILE}}
            BOSH_VCLOUD_CPI_VM_METADATA_KEY:       {{BOSH_VCLOUD_CPI_VM_METADATA_KEY}}
            BOSH_VCLOUD_CPI_IP:                    {{BOSH_VCLOUD_CPI_IP}}
            BOSH_VCLOUD_CPI_IP2:                   {{BOSH_VCLOUD_CPI_IP2}}
            BOSH_VCLOUD_CPI_NETMASK:               {{BOSH_VCLOUD_CPI_NETMASK}}
            BOSH_VCLOUD_CPI_DNS:                   {{BOSH_VCLOUD_CPI_DNS}}
            BOSH_VCLOUD_CPI_GATEWAY:               {{BOSH_VCLOUD_CPI_GATEWAY}}


resources:
  - name: bosh-cpi-dev-artifacts
    type: s3
    source:
      regexp: bosh-vcloud-cpi\.tgz
      bucket: bosh-vcloud-cpi-release
      region_name: us-east-1
      access_key_id:     {{s3_vcloud_cpi_access_key}}
      secret_access_key: {{s3_vcloud_cpi_secret_key}}

  - name: bosh-cpi-release
    type: git
    source:
      uri: git@github.com:cloudfoundry-incubator/bosh-vcloud-cpi-release.git
      branch: master
      private_key: {{github_deployment_key__bosh-vcloud-cpi-release}}

  - name: bosh-cpi-src
    type: git
    source:
      uri: https://github.com/cloudfoundry/bosh_vcloud_cpi.git
      branch: master

  - name: version-semver
    type: semver
    source:
      key:               current-version
      bucket:            bosh-vcloud-cpi-release
      access_key_id:     {{s3_vcloud_cpi_access_key}}
      secret_access_key: {{s3_vcloud_cpi_secret_key}}

  - name: bosh-concourse-ci
    type: git
    source:
      uri: git@github.com:cloudfoundry/bosh-concourse-ci.git
      branch: master
      private_key: {{github_deployment_key__bosh-concourse-ci}}

  - name: bosh-init
    type: s3
    source:
      regexp: bosh-init-([0-9.]+)-linux-amd64
      bucket: bosh-init-artifacts
      region_name: us-east-1

  - name: bosh-release
    type: bosh-io-release
    source:
      repository: cloudfoundry/bosh

  - name: vcloud-ubuntu-stemcell
    type: bosh-io-stemcell
    source:
      name: bosh-vcloud-esxi-ubuntu-trusty-go_agent

  - name: vcloud-centos-stemcell
    type: bosh-io-stemcell
    source:
      name: bosh-vsphere-esxi-centos-7-go_agent

  - name: bats
    type: git
    source:
      uri: https://github.com/cloudfoundry/bosh-acceptance-tests.git
      branch: concourse
